<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/routes/roles.php">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/routes/roles.php" />
              <option name="originalContent" value="&lt;?php&#10;&#10;&#10;use Illuminate\Support\Facades\Route;&#10;use Enadstack\LaravelRoles\Http\Controllers\RoleController;&#10;use Enadstack\LaravelRoles\Http\Controllers\PermissionController;&#10;// Package routes&#10;$guard = config('roles.guard', config('auth.defaults.guard', 'web'));&#10;&#10;// Example: protect with the configured guard&#10;Route::middleware(config('roles.routes.middleware', ['api']))&#10;    -&gt;prefix(config('roles.routes.prefix', 'admin/acl'))&#10;    -&gt;name('roles.')&#10;    -&gt;group(function () {&#10;        // Roles - CRUD&#10;        Route::get('/roles', [RoleController::class, 'index'])-&gt;name('index');&#10;        Route::post('/roles', [RoleController::class, 'store'])-&gt;name('store');&#10;        Route::get('/roles/{role}', [RoleController::class, 'show'])-&gt;name('show');&#10;        Route::put('/roles/{role}', [RoleController::class, 'update'])-&gt;name('update');&#10;        Route::delete('/roles/{role}', [RoleController::class, 'destroy'])-&gt;name('destroy');&#10;&#10;        // Roles - Advanced operations&#10;        Route::post('/roles/{id}/restore', [RoleController::class, 'restore'])-&gt;name('restore');&#10;        Route::delete('/roles/{role}/force', [RoleController::class, 'forceDelete'])-&gt;name('force-delete');&#10;        Route::post('/roles/bulk-delete', [RoleController::class, 'bulkDelete'])-&gt;name('bulk-delete');&#10;        Route::post('/roles/bulk-restore', [RoleController::class, 'bulkRestore'])-&gt;name('bulk-restore');&#10;        Route::post('/roles/bulk-force-delete', [RoleController::class, 'bulkForceDelete'])-&gt;name('bulk-force-delete');&#10;&#10;        // Roles - Data endpoints&#10;        Route::get('/roles-recent', [RoleController::class, 'recent'])-&gt;name('recent');&#10;        Route::get('/roles-stats', [RoleController::class, 'stats'])-&gt;name('stats');&#10;        &#10;        // Roles - Permission assignment&#10;        Route::post('/roles/{role}/permissions', [RoleController::class, 'assignPermissions'])-&gt;name('assign-permissions');&#10;        Route::get('/roles/{id}/permissions', [RoleController::class, 'permissions'])-&gt;name('permissions');&#10;        Route::get('/roles-permissions', [RoleController::class, 'permissionsGroupedByRole'])-&gt;name('permissions-grouped');&#10;&#10;        // Permissions - CRUD&#10;        Route::get('/permissions', [PermissionController::class, 'index'])-&gt;name('permissions.index');&#10;        Route::post('/permissions', [PermissionController::class, 'store'])-&gt;name('permissions.store');&#10;        Route::get('/permissions/{permission}', [PermissionController::class, 'show'])-&gt;name('permissions.show');&#10;        Route::put('/permissions/{permission}', [PermissionController::class, 'update'])-&gt;name('permissions.update');&#10;        Route::delete('/permissions/{permission}', [PermissionController::class, 'destroy'])-&gt;name('permissions.destroy');&#10;&#10;        Route::post('/permissions/{id}/restore', [PermissionController::class, 'restore'])-&gt;name('permissions.restore');&#10;        Route::post('/permissions/bulk-delete', [PermissionController::class, 'bulkDelete'])-&gt;name('permissions.bulk-delete');&#10;        Route::post('/permissions/bulk-restore', [PermissionController::class, 'bulkRestore'])-&gt;name('permissions.bulk-restore');&#10;        Route::delete('/permissions/{permission}/force', [PermissionController::class, 'forceDelete'])-&gt;name('permissions.force-delete');&#10;        Route::post('/permissions/bulk-force-delete', [PermissionController::class, 'bulkForceDelete'])-&gt;name('permissions.bulk-force-delete');&#10;&#10;        // Permissions - Data endpoints&#10;        Route::get('/permissions-recent', [PermissionController::class, 'recent'])-&gt;name('permissions.recent');&#10;        Route::get('/permissions-stats', [PermissionController::class, 'stats'])-&gt;name('permissions.stats');&#10;        Route::get('/permissions-matrix', [PermissionController::class, 'matrix'])-&gt;name('permissions.matrix');&#10;        &#10;        // Utility: grouped permissions&#10;        Route::get('/permission-groups', [PermissionController::class, 'groups'])-&gt;name('permissions.groups');&#10;&#10;        // Optional: endpoints for current user's ACL snapshot&#10;        if (config('roles.routes.expose_me')) {&#10;            Route::get('/me/roles', [\Enadstack\LaravelRoles\Http\Controllers\SelfAclController::class, 'roles'])-&gt;name('me.roles');&#10;            Route::get('/me/permissions', [\Enadstack\LaravelRoles\Http\Controllers\SelfAclController::class, 'permissions'])-&gt;name('me.permissions');&#10;            Route::get('/me/abilities', [\Enadstack\LaravelRoles\Http\Controllers\SelfAclController::class, 'abilities'])-&gt;name('me.abilities');&#10;        }&#10;&#10;        // Roles - Fine-grained permission ops and cloning&#10;        Route::post('/roles/{role}/permission', [RoleController::class, 'addPermission'])-&gt;name('permission.attach');&#10;        Route::delete('/roles/{role}/permission', [RoleController::class, 'removePermission'])-&gt;name('permission.detach');&#10;        Route::post('/roles/{role}/clone', [RoleController::class, 'clone'])-&gt;name('clone');&#10;    });" />
              <option name="updatedContent" value="&lt;?php&#10;&#10;&#10;use Illuminate\Support\Facades\Route;&#10;use Enadstack\LaravelRoles\Http\Controllers\RoleController;&#10;use Enadstack\LaravelRoles\Http\Controllers\PermissionController;&#10;// Package routes&#10;$guard = config('roles.guard', config('auth.defaults.guard', 'web'));&#10;&#10;// Example: protect with the configured guard&#10;Route::middleware(config('roles.routes.middleware', ['api']))&#10;    -&gt;prefix(config('roles.routes.prefix', 'admin/acl'))&#10;    -&gt;name('roles.')&#10;    -&gt;group(function () {&#10;        // Roles - CRUD&#10;        Route::get('/roles', [RoleController::class, 'index'])-&gt;name('index');&#10;        Route::post('/roles', [RoleController::class, 'store'])-&gt;name('store');&#10;        Route::get('/roles/{role}', [RoleController::class, 'show'])-&gt;name('show');&#10;        Route::put('/roles/{role}', [RoleController::class, 'update'])-&gt;name('update');&#10;        Route::delete('/roles/{role}', [RoleController::class, 'destroy'])-&gt;name('destroy');&#10;&#10;        // Roles - Advanced operations&#10;        Route::post('/roles/{id}/restore', [RoleController::class, 'restore'])-&gt;name('restore');&#10;        Route::delete('/roles/{role}/force', [RoleController::class, 'forceDelete'])-&gt;name('force-delete');&#10;        Route::post('/roles/bulk-delete', [RoleController::class, 'bulkDelete'])-&gt;name('bulk-delete');&#10;        Route::post('/roles/bulk-restore', [RoleController::class, 'bulkRestore'])-&gt;name('bulk-restore');&#10;        Route::post('/roles/bulk-force-delete', [RoleController::class, 'bulkForceDelete'])-&gt;name('bulk-force-delete');&#10;&#10;        // Roles - Data endpoints&#10;        Route::get('/roles-recent', [RoleController::class, 'recent'])-&gt;name('recent');&#10;        Route::get('/roles-stats', [RoleController::class, 'stats'])-&gt;name('stats');&#10;        &#10;        // Roles - Permission assignment&#10;        Route::post('/roles/{role}/permissions', [RoleController::class, 'assignPermissions'])-&gt;name('assign-permissions');&#10;        Route::get('/roles/{id}/permissions', [RoleController::class, 'permissions'])-&gt;name('permissions');&#10;        Route::get('/roles-permissions', [RoleController::class, 'permissionsGroupedByRole'])-&gt;name('permissions-grouped');&#10;&#10;        // Permissions - CRUD&#10;        Route::get('/permissions', [PermissionController::class, 'index'])-&gt;name('permissions.index');&#10;        Route::post('/permissions', [PermissionController::class, 'store'])-&gt;name('permissions.store');&#10;        Route::get('/permissions/{permission}', [PermissionController::class, 'show'])-&gt;name('permissions.show');&#10;        Route::put('/permissions/{permission}', [PermissionController::class, 'update'])-&gt;name('permissions.update');&#10;        Route::delete('/permissions/{permission}', [PermissionController::class, 'destroy'])-&gt;name('permissions.destroy');&#10;&#10;        Route::post('/permissions/{id}/restore', [PermissionController::class, 'restore'])-&gt;name('permissions.restore');&#10;        Route::post('/permissions/bulk-delete', [PermissionController::class, 'bulkDelete'])-&gt;name('permissions.bulk-delete');&#10;        Route::post('/permissions/bulk-restore', [PermissionController::class, 'bulkRestore'])-&gt;name('permissions.bulk-restore');&#10;        Route::delete('/permissions/{permission}/force', [PermissionController::class, 'forceDelete'])-&gt;name('permissions.force-delete');&#10;        Route::post('/permissions/bulk-force-delete', [PermissionController::class, 'bulkForceDelete'])-&gt;name('permissions.bulk-force-delete');&#10;&#10;        // Permissions - Data endpoints&#10;        Route::get('/permissions-recent', [PermissionController::class, 'recent'])-&gt;name('permissions.recent');&#10;        Route::get('/permissions-stats', [PermissionController::class, 'stats'])-&gt;name('permissions.stats');&#10;        Route::get('/permissions-matrix', [PermissionController::class, 'matrix'])-&gt;name('permissions.matrix');&#10;        &#10;        // Utility: grouped permissions&#10;        Route::get('/permission-groups', [PermissionController::class, 'groups'])-&gt;name('permissions.groups');&#10;&#10;        // Optional: endpoints for current user's ACL snapshot&#10;        if (config('roles.routes.expose_me')) {&#10;            Route::get('/me/roles', [\Enadstack\LaravelRoles\Http\Controllers\SelfAclController::class, 'roles'])-&gt;name('me.roles');&#10;            Route::get('/me/permissions', [\Enadstack\LaravelRoles\Http\Controllers\SelfAclController::class, 'permissions'])-&gt;name('me.permissions');&#10;            Route::get('/me/abilities', [\Enadstack\LaravelRoles\Http\Controllers\SelfAclController::class, 'abilities'])-&gt;name('me.abilities');&#10;        }&#10;&#10;        // Roles - Fine-grained permission ops and cloning&#10;        Route::post('/roles/{role}/permission', [RoleController::class, 'addPermission'])-&gt;name('permission.attach');&#10;        Route::delete('/roles/{role}/permission', [RoleController::class, 'removePermission'])-&gt;name('permission.detach');&#10;        Route::post('/roles/{role}/clone', [RoleController::class, 'clone'])-&gt;name('clone');&#10;    });" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/Commands/SyncCommand.php">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/Commands/SyncCommand.php" />
              <option name="originalContent" value="&lt;?php&#10;&#10;namespace Enadstack\LaravelRoles\Commands;&#10;&#10;use DB;&#10;use Illuminate\Console\Command;&#10;use Illuminate\Support\Arr;&#10;use Illuminate\Support\Facades\Schema;&#10;use Spatie\Permission\Models\Permission;&#10;use Spatie\Permission\Models\Role;&#10;use Enadstack\LaravelRoles\Database\Seeders\RolesSeeder;&#10;use Throwable;&#10;&#10;class SyncCommand extends Command&#10;{&#10;    protected $signature = 'roles:sync&#10;        {--guard= : Override guard (default from config)}&#10;        {--team-id= : When team_scoped, run sync against a specific tenant/team id}&#10;        {--no-map : Seed roles/permissions but skip mapping}&#10;        {--prune : Remove DB permissions not present in config}&#10;        {--dry-run : Show what would change without writing}&#10;    ';&#10;&#10;    protected $description = 'Sync roles &amp; permissions from config (idempotent).';&#10;&#10;    public function handle(): int&#10;    {&#10;        $guard = $this-&gt;option('guard') ?: config('roles.guard', 'web');&#10;        $dry   = (bool) $this-&gt;option('dry-run');&#10;&#10;        // Team/Tenancy context (Spatie teams)&#10;        $teamId = $this-&gt;option('team-id');&#10;        $isTeamScoped = config('roles.tenancy.mode') === 'team_scoped';&#10;        if ($isTeamScoped &amp;&amp; $teamId !== null) {&#10;            app()-&gt;instance('permission.team_id', $teamId);&#10;            $this-&gt;components-&gt;info(&quot;Syncing under team_id={$teamId}&quot;);&#10;        }&#10;&#10;        // 1) Seed/create/update (idempotent) using your existing logic&#10;        if ($dry) {&#10;            $this-&gt;components-&gt;info('Dry-run: would execute RolesSeeder (create/ensure roles &amp; permissions).');&#10;        } else {&#10;            $this-&gt;callSilent('db:seed', [&#10;                '--class' =&gt; RolesSeeder::class,&#10;            ]);&#10;        }&#10;&#10;        // 2) Optionally re-run mapping only (if you want to isolate mapping when --no-map is used)&#10;        if ($this-&gt;option('no-map')) {&#10;            $this-&gt;components-&gt;info('Skipped mapping (role-&gt;permissions) because --no-map set.');&#10;        } else {&#10;            // Reapply mapping from config (idempotent)&#10;            $map = (array) config('roles.seed.map', []);&#10;            if (! empty($map)) {&#10;                $this-&gt;components-&gt;info('Applying role-&gt;permission map from config…');&#10;                // use the same logic as seeder’s mapping section:&#10;                (new RolesSeeder())-&gt;run(); // already does mapping; fine to call once&#10;            }&#10;        }&#10;&#10;        // 3) Optional prune: remove permissions that aren’t in config&#10;        if ($this-&gt;option('prune')) {&#10;            $this-&gt;prune($guard, $dry);&#10;        }&#10;&#10;        if (! $dry) {&#10;            $this-&gt;callSilent('permission:cache-reset');&#10;        }&#10;&#10;        $this-&gt;components-&gt;info($dry ? 'Dry-run complete.' : 'Sync complete ✅');&#10;        return self::SUCCESS;&#10;    }&#10;&#10;    protected function prune(string $guard, bool $dry): void&#10;    {&#10;        $configured = $this-&gt;computeConfiguredPermissions($guard);&#10;        $existing   = Permission::where('guard_name', $guard)-&gt;pluck('name')-&gt;all();&#10;&#10;        $toDelete = array_values(array_diff($existing, $configured));&#10;&#10;        if (empty($toDelete)) {&#10;            $this-&gt;components-&gt;info('Prune: nothing to remove.');&#10;            return;&#10;        }&#10;&#10;        $this-&gt;warn('Prune will remove these permissions (and detach from roles):');&#10;        foreach ($toDelete as $p) {&#10;            $this-&gt;line(&quot;  - {$p}&quot;);&#10;        }&#10;&#10;        if ($dry) {&#10;            $this-&gt;components-&gt;info('Dry-run: skipping actual deletion.');&#10;            return;&#10;        }&#10;&#10;        foreach ($toDelete as $name) {&#10;            $permissionClass = config('permission.models.permission', Permission::class);&#10;            $perm = $permissionClass::where('guard_name', $guard)-&gt;where('name', $name)-&gt;first();&#10;            if (! $perm) continue;&#10;&#10;            // Try to delete with relationship detach first&#10;            try {&#10;                if (method_exists($perm, 'roles')) {&#10;                    $perm-&gt;roles()-&gt;detach();&#10;                }&#10;                $perm-&gt;delete();&#10;            } catch (Throwable $e) {&#10;                // If normal delete fails (relationship issues), try force delete&#10;                try {&#10;                    $perm-&gt;forceDelete();&#10;                } catch (Throwable $e2) {&#10;                    // Last resort: direct DB delete&#10;                    try {&#10;                        DB::table('permissions')&#10;                            -&gt;where('id', $perm-&gt;id)&#10;                            -&gt;delete();&#10;                    } catch (Throwable $e3) {&#10;                        $this-&gt;warn(&quot;Could not delete permission '{$name}': {$e3-&gt;getMessage()}&quot;);&#10;                        continue;&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        $this-&gt;components-&gt;info('Prune complete.');&#10;    }&#10;&#10;    protected function computeConfiguredPermissions(string $guard): array&#10;    {&#10;        $names = [];&#10;&#10;        // flat permissions&#10;        foreach ((array) config('roles.seed.permissions', []) as $p) {&#10;            $names[] = $p;&#10;        }&#10;&#10;        // grouped permissions &quot;&lt;group&gt;.&lt;action&gt;&quot;&#10;        foreach ((array) config('roles.seed.permission_groups', []) as $group =&gt; $actions) {&#10;            foreach ((array) $actions as $action) {&#10;                $names[] = &quot;{$group}.{$action}&quot;;&#10;            }&#10;        }&#10;&#10;        return array_values(array_unique($names));&#10;    }&#10;}" />
              <option name="updatedContent" value="&lt;?php&#10;&#10;namespace Enadstack\LaravelRoles\Commands;&#10;&#10;use Illuminate\Support\Facades\DB;&#10;use Illuminate\Console\Command;&#10;use Illuminate\Support\Arr;&#10;use Illuminate\Support\Facades\Schema;&#10;use Spatie\Permission\Models\Permission;&#10;use Spatie\Permission\Models\Role;&#10;use Enadstack\LaravelRoles\Database\Seeders\RolesSeeder;&#10;use Throwable;&#10;&#10;class SyncCommand extends Command&#10;{&#10;    protected $signature = 'roles:sync&#10;        {--guard= : Override guard (default from config)}&#10;        {--team-id= : When team_scoped, run sync against a specific tenant/team id}&#10;        {--no-map : Seed roles/permissions but skip mapping}&#10;        {--prune : Remove DB permissions not present in config}&#10;        {--dry-run : Show what would change without writing}&#10;    ';&#10;&#10;    protected $description = 'Sync roles &amp; permissions from config (idempotent).';&#10;&#10;    public function handle(): int&#10;    {&#10;        $guard = $this-&gt;option('guard') ?: config('roles.guard', 'web');&#10;        $dry   = (bool) $this-&gt;option('dry-run');&#10;&#10;        // Team/Tenancy context (Spatie teams)&#10;        $teamId = $this-&gt;option('team-id');&#10;        $isTeamScoped = config('roles.tenancy.mode') === 'team_scoped';&#10;        if ($isTeamScoped &amp;&amp; $teamId !== null) {&#10;            app()-&gt;instance('permission.team_id', $teamId);&#10;            $this-&gt;components-&gt;info(&quot;Syncing under team_id={$teamId}&quot;);&#10;        }&#10;&#10;        // 1) Seed/create/update (idempotent) using your existing logic&#10;        if ($dry) {&#10;            $this-&gt;components-&gt;info('Dry-run: would execute RolesSeeder (create/ensure roles &amp; permissions).');&#10;        } else {&#10;            $this-&gt;callSilent('db:seed', [&#10;                '--class' =&gt; RolesSeeder::class,&#10;            ]);&#10;        }&#10;&#10;        // 2) Optionally re-run mapping only (if you want to isolate mapping when --no-map is used)&#10;        if ($this-&gt;option('no-map')) {&#10;            $this-&gt;components-&gt;info('Skipped mapping (role-&gt;permissions) because --no-map set.');&#10;        } else {&#10;            // Reapply mapping from config (idempotent)&#10;            $map = (array) config('roles.seed.map', []);&#10;            if (! empty($map)) {&#10;                $this-&gt;components-&gt;info('Applying role-&gt;permission map from config…');&#10;                // use the same logic as seeder’s mapping section:&#10;                (new RolesSeeder())-&gt;run(); // already does mapping; fine to call once&#10;            }&#10;        }&#10;&#10;        // 3) Optional prune: remove permissions that aren’t in config&#10;        if ($this-&gt;option('prune')) {&#10;            $this-&gt;prune($guard, $dry);&#10;        }&#10;&#10;        if (! $dry) {&#10;            $this-&gt;callSilent('permission:cache-reset');&#10;        }&#10;&#10;        $this-&gt;components-&gt;info($dry ? 'Dry-run complete.' : 'Sync complete ✅');&#10;        return self::SUCCESS;&#10;    }&#10;&#10;    protected function prune(string $guard, bool $dry): void&#10;    {&#10;        $configured = $this-&gt;computeConfiguredPermissions($guard);&#10;        $existing   = Permission::where('guard_name', $guard)-&gt;pluck('name')-&gt;all();&#10;&#10;        $toDelete = array_values(array_diff($existing, $configured));&#10;&#10;        if (empty($toDelete)) {&#10;            $this-&gt;components-&gt;info('Prune: nothing to remove.');&#10;            return;&#10;        }&#10;&#10;        $this-&gt;warn('Prune will remove these permissions (and detach from roles):');&#10;        foreach ($toDelete as $p) {&#10;            $this-&gt;line(&quot;  - {$p}&quot;);&#10;        }&#10;&#10;        if ($dry) {&#10;            $this-&gt;components-&gt;info('Dry-run: skipping actual deletion.');&#10;            return;&#10;        }&#10;&#10;        foreach ($toDelete as $name) {&#10;            $permissionClass = config('permission.models.permission', Permission::class);&#10;            $perm = $permissionClass::where('guard_name', $guard)-&gt;where('name', $name)-&gt;first();&#10;            if (! $perm) continue;&#10;&#10;            // Try to delete with relationship detach first&#10;            try {&#10;                if (method_exists($perm, 'roles')) {&#10;                    $perm-&gt;roles()-&gt;detach();&#10;                }&#10;                $perm-&gt;delete();&#10;            } catch (Throwable $e) {&#10;                // If normal delete fails (relationship issues), try force delete&#10;                try {&#10;                    $perm-&gt;forceDelete();&#10;                } catch (Throwable $e2) {&#10;                    // Last resort: direct DB delete&#10;                    try {&#10;                        DB::table('permissions')&#10;                            -&gt;where('id', $perm-&gt;id)&#10;                            -&gt;delete();&#10;                    } catch (Throwable $e3) {&#10;                        $this-&gt;warn(&quot;Could not delete permission '{$name}': {$e3-&gt;getMessage()}&quot;);&#10;                        continue;&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        $this-&gt;components-&gt;info('Prune complete.');&#10;    }&#10;&#10;    protected function computeConfiguredPermissions(string $guard): array&#10;    {&#10;        $names = [];&#10;&#10;        // flat permissions&#10;        foreach ((array) config('roles.seed.permissions', []) as $p) {&#10;            $names[] = $p;&#10;        }&#10;&#10;        // grouped permissions &quot;&lt;group&gt;.&lt;action&gt;&quot;&#10;        foreach ((array) config('roles.seed.permission_groups', []) as $group =&gt; $actions) {&#10;            foreach ((array) $actions as $action) {&#10;                $names[] = &quot;{$group}.{$action}&quot;;&#10;            }&#10;        }&#10;&#10;        return array_values(array_unique($names));&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>